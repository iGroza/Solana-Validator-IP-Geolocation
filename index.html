<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Solana Validators Visualization - Explore Geographical Distribution
    </title>
    <meta
      name="description"
      content="Visualize Solana validators' geographical distribution with interactive maps and charts. Download the latest CSV data and explore validator statistics."
    />
    <meta
      name="keywords"
      content="Solana, Validators, Visualization, Geographical Distribution, Interactive Maps, Charts, CSV Data, Validator Statistics"
    />
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "Solana Validators Visualization",
        "description": "Interactive visualization of Solana validators' geographical distribution.",
        "url": "https://github.com/iGroza/Solana-Validator-IP-Geolocation"
      }
    </script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Add ag-grid styles and scripts -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.3/styles/ag-grid.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.3/styles/ag-theme-material.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.3/dist/ag-grid-community.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-primary: #121212;
        --bg-secondary: #1e1e1e;
        --bg-tertiary: #252525;
        --text-primary: #ffffff;
        --text-secondary: #b3b3b3;
        --accent-primary: #9945ff;
        --accent-secondary: #14f195;
        --border-color: #333333;
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        --hover-color: #2a2a2a;
      }

      body {
        font-family: "Inter", "Segoe UI", Arial, sans-serif;
        line-height: 1.6;
        padding: 20px;
        background-color: var(--bg-primary);
        color: var(--text-primary);
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
      }

      .header-title {
        display: flex;
        flex-direction: column;
      }

      h1 {
        font-weight: 700;
        font-size: 2.2rem;
        margin-bottom: 5px;
        background: linear-gradient(
          90deg,
          var(--accent-primary),
          var(--accent-secondary)
        );
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      h3 {
        font-size: 1.4rem;
        margin-bottom: 16px;
        color: var(--text-primary);
        font-weight: 600;
      }

      p {
        color: var(--text-secondary);
      }

      .header-buttons {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      .switch-container {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: 12px;
        min-width: 140px;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 22px;
        flex-shrink: 0;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--bg-tertiary);
        transition: 0.4s;
        border-radius: 22px;
        border: 1px solid var(--border-color);
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 14px;
        width: 14px;
        left: 3px;
        bottom: 3px;
        background-color: var(--text-secondary);
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--accent-secondary);
      }

      input:checked + .slider:before {
        transform: translateX(22px);
        background-color: #000;
      }

      .switch-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
        font-weight: 500;
        white-space: nowrap;
      }

      .button {
        padding: 10px 20px;
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s ease;
        border: 1px solid var(--border-color);
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .button:hover {
        background-color: var(--hover-color);
        transform: translateY(-2px);
        box-shadow: var(--card-shadow);
      }

      .download-btn {
        background-color: var(--accent-secondary);
        color: #000;
        border: none;
      }

      .download-btn:hover {
        background-color: #12d985;
        color: #000;
      }

      #statistics {
        margin-bottom: 40px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(222px, 1fr));
        gap: 15px;
      }

      .stat-item {
        background-color: var(--bg-secondary);
        padding: 20px;
        border-radius: 10px;
        box-shadow: var(--card-shadow);
        transition: transform 0.3s ease;
        border: 1px solid var(--border-color);
      }

      .stat-item:hover {
        transform: translateY(-5px);
      }

      .stat-label {
        font-weight: 600;
        color: var(--text-secondary);
        display: block;
        margin-bottom: 8px;
        font-size: 0.9rem;
        text-transform: uppercase;
      }

      .stat-item span:not(.stat-label) {
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--accent-primary);
      }

      #map {
        height: 60vh;
        margin-bottom: 50px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--border-color);
      }

      .chart {
        width: 100%;
        min-width: 0;
        background-color: var(--bg-secondary);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
      }

      .chart canvas {
        height: 300px !important;
        width: 100% !important;
      }

      /* Version charts grid */
      .version-charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
        width: 100%;
      }

      .version-charts-grid .chart {
        margin-bottom: 0;
      }

      .version-charts-grid .chart canvas {
        height: 400px !important;
      }

      /* Main charts grid */
      .charts-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap: 20px;
        margin-top: 30px;
        width: 100%;
      }

      .charts-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 100%;
      }

      .charts-column .chart {
        display: flex;
        flex-direction: column;
        height: 450px;
        align-items: center;
        justify-content: center;
      }

      .charts-column .chart canvas {
        height: 300px !important;
        width: 100% !important;
        min-height: unset;
      }

      .charts-column h2 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 1.8rem;
        background: linear-gradient(
          90deg,
          var(--accent-primary),
          var(--accent-secondary)
        );
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      @media (max-width: 768px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .header-buttons {
          margin-top: 15px;
          width: 100%;
          justify-content: flex-start;
        }

        .button {
          flex: 0 1 auto;
          justify-content: center;
        }

        .switch-container {
          margin-left: 0;
          margin-top: 8px;
          width: 100%;
        }

        h1 {
          font-size: 1.8rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .version-charts-grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .version-charts-grid .chart canvas {
          height: 300px !important;
        }

        .charts-grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .chart {
          margin-bottom: 0;
        }

        .charts-column {
          gap: 20px;
        }

        .charts-column h2 {
          margin-top: 30px;
          margin-bottom: 20px;
        }
      }

      /* Remove any duplicate chart styles */
      canvas {
        max-height: unset;
      }

      /* Leaflet map customization */
      .leaflet-container {
        background-color: #0a0a0a !important;
      }

      .leaflet-popup-content-wrapper {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
      }

      .leaflet-popup-tip {
        background-color: var(--bg-secondary);
      }

      /* Add styles for CSV viewer section */
      .csv-viewer {
        margin-top: 50px;
        padding: 20px;
        background-color: var(--bg-secondary);
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--border-color);
      }

      .csv-viewer h3 {
        margin-bottom: 20px;
        text-align: center;
      }

      .csv-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .csv-controls input {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
        flex: 1;
        min-width: 200px;
      }

      .csv-controls input:focus {
        outline: none;
        border-color: var(--accent-primary);
      }

      /* AG Grid Theme Overrides - minimal overrides for consistency */
      .ag-theme-alpine {
        --ag-background-color: var(--bg-secondary);
        --ag-header-background-color: var(--bg-tertiary);
        --ag-odd-row-background-color: var(--bg-primary);
        --ag-header-foreground-color: var(--text-primary);
        --ag-foreground-color: var(--text-primary);
        --ag-secondary-foreground-color: var(--text-secondary);
        --ag-border-color: var(--border-color);
        --ag-row-hover-color: var(--hover-color);
        --ag-selected-row-background-color: var(--accent-primary);
        --ag-font-size: 14px;
        height: 600px;
        width: 100%;
      }

      .ag-root {
        border-radius: 8px;
        overflow: hidden;
      }

      .ag-center-cols-container {
        min-width: 100%;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-title">
        <h1>Solana Validators Visualization</h1>
        <p id="last-update"></p>
        <img
          width="50px"
          src="https://badges.pufler.dev/visits/iGroza/Solana-Validator-IP-Geolocation-page123"
        />
      </div>
      <div class="header-buttons">
        <a
          href="https://github.com/iGroza/Solana-Validator-IP-Geolocation"
          class="button"
          ><svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M12 0C5.37 0 0 5.37 0 12C0 17.31 3.435 21.795 8.205 23.385C8.805 23.49 9.03 23.13 9.03 22.815C9.03 22.53 9.015 21.585 9.015 20.58C6 21.135 5.22 19.845 4.98 19.17C4.845 18.825 4.26 17.76 3.75 17.475C3.33 17.25 2.73 16.695 3.735 16.68C4.68 16.665 5.355 17.55 5.58 17.91C6.66 19.725 8.385 19.215 9.075 18.9C9.18 18.12 9.495 17.595 9.84 17.295C7.17 16.995 4.38 15.96 4.38 11.37C4.38 10.065 4.845 8.985 5.61 8.145C5.49 7.845 5.07 6.615 5.73 4.965C5.73 4.965 6.735 4.65 9.03 6.195C9.99 5.925 11.01 5.79 12.03 5.79C13.05 5.79 14.07 5.925 15.03 6.195C17.325 4.635 18.33 4.965 18.33 4.965C18.99 6.615 18.57 7.845 18.45 8.145C19.215 8.985 19.68 10.05 19.68 11.37C19.68 15.975 16.875 16.995 14.205 17.295C14.64 17.67 15.015 18.39 15.015 19.515C15.015 21.12 15 22.41 15 22.815C15 23.13 15.225 23.505 15.825 23.385C18.2072 22.5807 20.2772 21.0497 21.7437 19.0074C23.2101 16.965 23.9993 14.5143 24 12C24 5.37 18.63 0 12 0Z"
              fill="currentColor"
            /></svg
          >View on GitHub</a
        >
        <a href="solana_validators.csv" download class="button download-btn"
          ><svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path d="M12 16L7 11H10V4H14V11H17L12 16Z" fill="currentColor" />
            <path
              d="M20 18H4V11H2V18C2 19.103 2.897 20 4 20H20C21.103 20 22 19.103 22 18V11H20V18Z"
              fill="currentColor"
            /></svg
          >Download CSV</a
        >
        <div class="switch-container">
          <span class="switch-label">Show Jito Only</span>
          <label class="switch">
            <input type="checkbox" id="jito-filter" />
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </header>
    <main>
      <section id="statistics">
        <h3>Validator Statistics</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-label">Total staked (SOL)</span>
            <span id="total-staked"></span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Total validators</span>
            <span id="total-validators"></span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Unique cities</span>
            <span id="unique-cities"></span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Unique regions</span>
            <span id="unique-regions"></span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Unique hosting providers</span>
            <span id="unique-hosting"></span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Unique countries</span>
            <span id="unique-countries"></span>
          </div>
        </div>
      </section>
      <section id="map-section">
        <h3>Geographical Distribution of Validators</h3>
        <div id="map"></div>
      </section>
      <section id="charts">
        <div class="charts-grid">
          <div class="charts-column">
            <div class="chart">
              <h3>Validator Versions Distribution</h3>
              <canvas id="version-chart"></canvas>
            </div>
          </div>
          <div class="charts-column">
            <div class="chart">
              <h3>Jito vs Regular Validators</h3>
              <canvas id="jito-distribution-chart"></canvas>
            </div>
          </div>
        </div>
        <div class="charts-grid">
          <div class="charts-column">
            <h2>Validators Count</h2>
            <div class="chart">
              <h3>Top 10 Cities</h3>
              <canvas id="city-chart"></canvas>
            </div>
            <div class="chart">
              <h3>Top 10 Regions</h3>
              <canvas id="region-chart"></canvas>
            </div>
            <div class="chart">
              <h3>Top 10 Hosting Providers</h3>
              <canvas id="hosting-chart"></canvas>
            </div>
            <div class="chart">
              <h3>Top 10 Countries</h3>
              <canvas id="country-chart"></canvas>
            </div>
          </div>
          <div class="charts-column">
            <h2>SOL Staking</h2>
            <div class="chart">
              <h3>Top 10 Cities by Activated Stake</h3>
              <canvas id="city-stake-chart"></canvas>
            </div>
            <div class="chart">
              <h3>Top 10 Regions by Activated Stake</h3>
              <canvas id="region-stake-chart"></canvas>
            </div>
            <div class="chart">
              <h3>Top 10 Hosting Providers by Activated Stake</h3>
              <canvas id="hosting-stake-chart"></canvas>
            </div>
            <div class="chart">
              <h3>Top 10 Countries by Activated Stake</h3>
              <canvas id="country-stake-chart"></canvas>
            </div>
          </div>
        </div>
      </section>
      <section class="csv-viewer">
        <h3>Interactive CSV Viewer</h3>
        <div class="csv-controls">
          <input
            type="text"
            id="csv-search"
            placeholder="Search across all columns..."
          />
        </div>
        <div id="csv-grid" class="ag-theme-alpine"></div>
      </section>
    </main>
    <footer>
      <p id="footer"></p>
    </footer>
    <script>
      // Set dark mode for Chart.js
      Chart.defaults.color = "#b3b3b3";
      Chart.defaults.borderColor = "#333333";

      const LAMPORTS_PER_SOL = 1000000000;

      // Common chart options
      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: "rgba(255, 255, 255, 0.1)",
            },
          },
          x: {
            grid: {
              color: "rgba(255, 255, 255, 0.1)",
            },
            ticks: {
              maxRotation: 45,
              minRotation: 45,
            },
          },
        },
        plugins: {
          legend: {
            labels: {
              color: "#b3b3b3",
            },
          },
        },
        layout: {
          padding: {
            left: 15,
            right: 15,
            top: 15,
            bottom: 15,
          },
        },
      };

      // Pie chart options with tooltips
      const pieChartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "right",
            labels: {
              color: "#b3b3b3",
            },
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                const value = context.raw;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `Count: ${value} (${percentage}%)`;
              },
            },
          },
        },
        layout: {
          padding: {
            left: 15,
            right: 15,
            top: 15,
            bottom: 15,
          },
        },
      };

      document.addEventListener("DOMContentLoaded", async () => {
        const footer = document.getElementById("footer");
        footer.innerHTML = `© ${new Date().getFullYear()} Powered with ♥️ by <a href="https://t.me/iGroza" target="_blank" class="footer-link">@iGroza</a>`;
        footer.style.textAlign = "center";
        footer.style.margin = "20px 0";

        const style = document.createElement("style");
        style.textContent = `
          .footer-link {
            color: var(--accent-primary) !important;
            font-weight: bold;
            text-decoration: none;
            transition: color 0.3s ease;
          }
          .footer-link:hover {
            color: var(--accent-secondary) !important;
          }
          .footer-link:visited {
            color: var(--accent-primary) !important;
          }
        `;
        document.head.appendChild(style);

        try {
          const { timestamp } = await fetch(
            "https://igroza.github.io/Solana-Validator-IP-Geolocation/last_update.json"
          ).then((r) => r.json());
          document.getElementById(
            "last-update"
          ).textContent = `Last update: ${new Date(
            timestamp
          ).toDateString()} (automatic update every 24 hours)`;
        } catch (error) {
          console.error("Error fetching last update:", error);
          document.getElementById("last-update").textContent =
            "Last update: Data unavailable";
        }
      });

      const chartColors = {
        backgroundColor: [
          "rgba(153, 69, 255, 0.5)",
          "rgba(20, 241, 149, 0.5)",
          "rgba(255, 102, 102, 0.5)",
          "rgba(54, 162, 235, 0.5)",
          "rgba(255, 206, 86, 0.5)",
          "rgba(75, 192, 192, 0.5)",
          "rgba(153, 102, 255, 0.5)",
          "rgba(255, 159, 64, 0.5)",
          "rgba(199, 199, 199, 0.5)",
          "rgba(83, 102, 255, 0.5)",
        ],
        borderColor: [
          "rgba(153, 69, 255, 1)",
          "rgba(20, 241, 149, 1)",
          "rgba(255, 102, 102, 1)",
          "rgba(54, 162, 235, 1)",
          "rgba(255, 206, 86, 1)",
          "rgba(75, 192, 192, 1)",
          "rgba(153, 102, 255, 1)",
          "rgba(255, 159, 64, 1)",
          "rgba(199, 199, 199, 1)",
          "rgba(83, 102, 255, 1)",
        ],
      };

      d3.csv("solana_validators.csv")
        .then(function (data) {
          let filteredData = [...data];
          const jitoFilter = document.getElementById("jito-filter");

          // Initialize CSV viewer
          const gridOptions = {
            columnDefs: [
              {
                field: "IP",
                headerName: "IP",
                filter: true,
                minWidth: 120,
                suppressSizeToFit: true,
              },
              {
                field: "City",
                headerName: "City",
                filter: true,
                minWidth: 120,
                suppressSizeToFit: true,
              },
              {
                field: "Region",
                headerName: "Region",
                filter: true,
                minWidth: 120,
                suppressSizeToFit: true,
              },
              {
                field: "Country",
                headerName: "Country",
                filter: true,
                minWidth: 120,
                suppressSizeToFit: true,
              },
              {
                field: "Loc",
                headerName: "Location (lat, lon)",
                filter: true,
                minWidth: 120,
                suppressSizeToFit: true,
              },
              {
                field: "Hosting",
                headerName: "Hosting",
                filter: true,
                minWidth: 120,
                suppressSizeToFit: true,
              },
              {
                field: "HostingCompanyId",
                headerName: "Hosting Company ID",
                filter: true,
                minWidth: 150,
                suppressSizeToFit: true,
              },
              {
                field: "Timezone",
                headerName: "Timezone",
                filter: true,
                minWidth: 120,
                suppressSizeToFit: true,
              },
              {
                field: "Name",
                headerName: "Name",
                filter: true,
                minWidth: 120,
                suppressSizeToFit: true,
              },
              {
                field: "Website",
                headerName: "Website",
                filter: true,
                minWidth: 150,
                suppressSizeToFit: true,
              },
              {
                field: "IconUrl",
                headerName: "Icon URL",
                filter: true,
                minWidth: 150,
                suppressSizeToFit: true,
              },
              {
                field: "Details",
                headerName: "Details",
                filter: true,
                minWidth: 150,
                suppressSizeToFit: true,
              },
              {
                field: "KeybaseUsername",
                headerName: "Keybase Username",
                filter: true,
                minWidth: 150,
                suppressSizeToFit: true,
              },
              {
                field: "ActivatedStake",
                headerName: "Stake (SOL)",
                filter: true,
                minWidth: 120,
                valueFormatter: (params) =>
                  (params.value / LAMPORTS_PER_SOL).toLocaleString(),
                suppressSizeToFit: true,
              },
              {
                field: "Commission",
                headerName: "Commission",
                filter: true,
                minWidth: 100,
                suppressSizeToFit: true,
              },
              {
                field: "ValidatorVersion",
                headerName: "Version",
                filter: true,
                minWidth: 100,
                suppressSizeToFit: true,
              },
              {
                field: "IsJito",
                headerName: "Jito",
                filter: true,
                minWidth: 80,
                suppressSizeToFit: true,
              },
              {
                field: "NodePubkey",
                headerName: "Node Pubkey",
                filter: true,
                minWidth: 150,
                suppressSizeToFit: true,
              },
              {
                field: "VotePubkey",
                headerName: "Vote Pubkey",
                filter: true,
                minWidth: 150,
                suppressSizeToFit: true,
              },
              {
                field: "ProgramAccount",
                headerName: "Program Account",
                filter: true,
                minWidth: 150,
                suppressSizeToFit: true,
              },
            ],
            defaultColDef: {
              sortable: true,
              resizable: true,
              filter: true,
              enableCellTextSelection: true,
              selectable: true,
            },
            enableCellTextSelection: true,
            ensureDomOrder: true,
            suppressCopyRowsToClipboard: false,
            rowSelection: "multiple",
            suppressRowClickSelection: true,
            rowData: data,
            pagination: true,
            paginationPageSize: 100,
            domLayout: "normal",
            suppressHorizontalScroll: false,
            onGridReady: (params) => {
              params.api.sizeColumnsToFit();
            },
          };

          const gridDiv = document.querySelector("#csv-grid");
          new agGrid.Grid(gridDiv, gridOptions);

          // Add search functionality
          const searchInput = document.querySelector("#csv-search");
          searchInput.addEventListener("input", (e) => {
            gridOptions.api.setQuickFilter(e.target.value);
          });

          // Update grid when Jito filter changes
          jitoFilter.addEventListener("change", function () {
            filteredData = this.checked
              ? data.filter((row) => row.IsJito === "true")
              : [...data];
            gridOptions.api.setRowData(filteredData);
            updateVisualizations();
          });

          // Helper functions
          function countFrequency(data, column) {
            const frequency = {};
            data.forEach(function (row) {
              let value = row[column] || "Unknown";
              frequency[value] = (frequency[value] || 0) + 1;
            });
            return frequency;
          }

          function sumActivatedStake(data, column) {
            const stakeSum = {};
            data.forEach(function (row) {
              let value = row[column] || "Unknown";
              let stake = parseInt(row.ActivatedStake) || 0;
              stakeSum[value] = (stakeSum[value] || 0) + stake;
            });
            return stakeSum;
          }

          function updateVisualizations() {
            // Update statistics
            document.getElementById("total-staked").textContent = (
              filteredData.reduce(
                (acc, curr) => acc + Number(curr.ActivatedStake),
                0
              ) / LAMPORTS_PER_SOL
            ).toLocaleString({});
            document.getElementById("total-validators").textContent =
              filteredData.length;
            document.getElementById("unique-cities").textContent = new Set(
              filteredData.map((d) => d.City)
            ).size;
            document.getElementById("unique-regions").textContent = new Set(
              filteredData.map((d) => d.Region)
            ).size;
            document.getElementById("unique-hosting").textContent = new Set(
              filteredData.map((d) => d.Hosting)
            ).size;
            document.getElementById("unique-countries").textContent = new Set(
              filteredData.map((d) => d.Country)
            ).size;

            // Clear existing markers
            map.eachLayer((layer) => {
              if (layer instanceof L.Marker) {
                map.removeLayer(layer);
              }
            });

            // Add new markers
            filteredData.forEach(function (row) {
              if (row.Loc) {
                const [lat, lon] = row.Loc.split(" ").map(Number);
                if (!isNaN(lat) && !isNaN(lon)) {
                  const marker = L.marker([lat, lon], { icon: solanaIcon })
                    .addTo(map)
                    .bindPopup(
                      `<div style="padding: 1px;">
                        ${row.Name ? `<strong>Name:</strong> ${row.Name}<br><hr>` : ''}
                        ${row.Details ? `<strong>Details:</strong> ${row.Details}<br><hr>` : ''}
                        ${row.Website ? `<strong>Website:</strong> <a href="${row.Website}" target="_blank">${row.Website}</a><br><hr>` : ''}
                        ${row.IconUrl ? `<strong>Icon:</strong> <img src="${row.IconUrl}" width="24" height="24" style="vertical-align: middle;"><br><hr>` : ''}
                        ${row.KeybaseUsername ? `<strong>Keybase:</strong> <a href="https://keybase.io/${row.KeybaseUsername}" target="_blank">${row.KeybaseUsername}</a><br><hr>` : ''}
                        
                        ${row.NodePubkey ? `<strong>Node Pubkey:</strong> <a href="https://explorer.solana.com/address/${row.NodePubkey}" target="_blank">${row.NodePubkey.substring(0, 8)}...</a><br><hr>` : ''}
                        ${row.VotePubkey ? `<strong>Vote Pubkey:</strong> <a href="https://explorer.solana.com/address/${row.VotePubkey}" target="_blank">${row.VotePubkey.substring(0, 8)}...</a><br><hr>` : ''}
                        ${row.ProgramAccount ? `<strong>Program Account:</strong> <a href="https://explorer.solana.com/address/${row.ProgramAccount}" target="_blank">${row.ProgramAccount.substring(0, 8)}...</a><br><hr>` : ''}
                        ${row.ValidatorVersion ? `<strong>Version:</strong> ${row.ValidatorVersion}<br><hr>` : ''}
                        ${row.IsJito !== undefined ? `<strong>Jito:</strong> ${row.IsJito ? 'Yes' : 'No'}<br><hr>` : ''}
                        
                        ${row.City ? `<strong>City:</strong> ${row.City}<br><hr>` : ''}
                        ${row.Region ? `<strong>Region:</strong> ${row.Region}<br><hr>` : ''}
                        ${row.Hosting ? `<strong>Hosting:</strong> ${row.Hosting}<br><hr>` : ''}
                        
                        <strong>Stake:</strong> ${(row.ActivatedStake / LAMPORTS_PER_SOL).toLocaleString()} SOL
                      </div>`
                    );

                  // Add click event handler
                  marker.on("click", function (e) {
                    e.target.openPopup();
                    const popup = e.target.getPopup();
                    const popupContent = popup.getContent();
                    const popupElement = popup.getElement();
                    
                    // Wait for popup to be added to DOM
                    setTimeout(() => {
                      if (popupElement) {
                        const popupHeight = popupElement.offsetHeight;
                        const mapHeight = map.getContainer().offsetHeight;
                        const latLng = e.target.getLatLng();
                        
                        // Calculate offset to center popup vertically
                        const offsetY = (popupHeight / mapHeight) * 100;
                        
                        // Adjust map view to show full popup
                        map.setView(latLng, map.getZoom(), {
                          pan: {
                            duration: 0.5,
                            animate: true
                          }
                        });
                        
                        // Pan map to center popup vertically
                        map.panBy([0, -offsetY], {
                          duration: 0.5,
                          animate: true
                        });
                      }
                    }, 100);
                  });
                }
              }
            });

            // Update charts
            updateChart("city-chart", countFrequency(filteredData, "City"));
            updateChart("region-chart", countFrequency(filteredData, "Region"));
            updateChart(
              "hosting-chart",
              countFrequency(filteredData, "Hosting")
            );
            updateChart(
              "country-chart",
              countFrequency(filteredData, "Country")
            );
            updateChart(
              "city-stake-chart",
              sumActivatedStake(filteredData, "City"),
              true
            );
            updateChart(
              "region-stake-chart",
              sumActivatedStake(filteredData, "Region"),
              true
            );
            updateChart(
              "hosting-stake-chart",
              sumActivatedStake(filteredData, "Hosting"),
              true
            );
            updateChart(
              "country-stake-chart",
              sumActivatedStake(filteredData, "Country"),
              true
            );
            updateVersionChart(filteredData);
            updateJitoDistributionChart(filteredData);
          }

          function updateChart(chartId, data, isStake = false) {
            const sortedData = Object.entries(data)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 10);
            const labels = sortedData.map((d) => d[0]);
            const values = sortedData.map((d) =>
              isStake ? d[1] / LAMPORTS_PER_SOL : d[1]
            );

            const chart = Chart.getChart(chartId);
            if (chart) {
              chart.destroy();
            }

            new Chart(document.getElementById(chartId).getContext("2d"), {
              type: "bar",
              data: {
                labels: labels,
                datasets: [
                  {
                    label: isStake
                      ? "Activated Stake (SOL)"
                      : "Number of Validators",
                    data: values,
                    backgroundColor: chartColors.backgroundColor,
                    borderColor: chartColors.borderColor,
                    borderWidth: 1,
                  },
                ],
              },
              options: chartOptions,
            });
          }

          function updateVersionChart(data) {
            const versionData = countFrequency(data, "ValidatorVersion");
            const sortedData = Object.entries(versionData).sort(
              (a, b) => b[1] - a[1]
            );

            const total = sortedData.reduce(
              (sum, [_, count]) => sum + count,
              0
            );
            const labels = sortedData.map(
              ([version, count]) =>
                `${version} (${((count / total) * 100).toFixed(1)}%)`
            );

            const chart = Chart.getChart("version-chart");
            if (chart) {
              chart.destroy();
            }

            new Chart(
              document.getElementById("version-chart").getContext("2d"),
              {
                type: "pie",
                data: {
                  labels: labels,
                  datasets: [
                    {
                      data: sortedData.map((d) => d[1]),
                      backgroundColor: chartColors.backgroundColor,
                      borderColor: chartColors.borderColor,
                      borderWidth: 1,
                    },
                  ],
                },
                options: pieChartOptions,
              }
            );
          }

          function updateJitoDistributionChart(data) {
            const jitoCount = data.filter((d) => d.IsJito === "true").length;
            const regularCount = data.length - jitoCount;
            const total = data.length;

            const jitoPercentage = ((jitoCount / total) * 100).toFixed(1);
            const regularPercentage = ((regularCount / total) * 100).toFixed(1);

            const chart = Chart.getChart("jito-distribution-chart");
            if (chart) {
              chart.destroy();
            }

            new Chart(
              document
                .getElementById("jito-distribution-chart")
                .getContext("2d"),
              {
                type: "pie",
                data: {
                  labels: [
                    `Jito Validators (${jitoPercentage}%)`,
                    `Regular Validators (${regularPercentage}%)`,
                  ],
                  datasets: [
                    {
                      data: [jitoCount, regularCount],
                      backgroundColor: [
                        chartColors.backgroundColor[0],
                        chartColors.backgroundColor[1],
                      ],
                      borderColor: [
                        chartColors.borderColor[0],
                        chartColors.borderColor[1],
                      ],
                      borderWidth: 1,
                    },
                  ],
                },
                options: pieChartOptions,
              }
            );
          }

          // Initialize map with dark style
          const map = L.map("map", {
            maxBounds: [
              [-90, -180],
              [90, 180],
            ],
            maxBoundsViscosity: 1.0,
            minZoom: 2,
            maxZoom: 19,
          }).setView([0, 0], 2);
          L.tileLayer(
            "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
            {
              attribution:
                '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
              subdomains: "abcd",
              maxZoom: 19,
            }
          ).addTo(map);

          // Add world boundary layer
          fetch(
            "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json"
          )
            .then((response) => response.json())
            .then((data) => {
              L.geoJSON(data, {
                style: {
                  color: "#333333",
                  weight: 1,
                  fillColor: "transparent",
                },
              }).addTo(map);
            })
            .catch((error) =>
              console.error("Error loading world boundary:", error)
            );

          // Custom marker icon
          const solanaIcon = L.divIcon({
            html: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" fill="#9945FF" opacity="0.8" />
                    <circle cx="12" cy="12" r="5" fill="#14F195" />
                  </svg>`,
            className: "",
            iconSize: [24, 24],
            iconAnchor: [12, 12],
          });

          // Initial visualization
          updateVisualizations();

          // Add styles for text selection
          const style = document.createElement("style");
          style.textContent = `
            .ag-cell {
              user-select: text !important;
              -webkit-user-select: text !important;
              -moz-user-select: text !important;
              -ms-user-select: text !important;
            }
          `;
          document.head.appendChild(style);
        })
        .catch(function (error) {
          console.error("Error loading CSV file:", error);
          document.body.innerHTML += `<div style="text-align: center; padding: 20px; background-color: rgba(255, 0, 0, 0.1); color: #ff6b6b; border-radius: 10px; margin: 20px auto; max-width: 600px;">
            <h3>Error Loading Data</h3>
            <p>Could not load the Solana validators data. Please check your connection and try again.</p>
          </div>`;
        });
    </script>
  </body>
</html>
